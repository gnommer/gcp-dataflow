steps:
  - name: gcr.io/cloud-builders/git
    args: ["fetch", "--unshallow"]

  - name: gcr.io/cloud-builders/git
    entrypoint: /bin/bash
    args: ["-c", "echo $(date +'%Y%m%d').$(expr $(git rev-list --count main) - $(git rev-list --count main --since=$(date -v-1d +'%d-%m-%Y'))) > BUILD_NO"]
  
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: build-dataflow-container
    env:
    - PROJECT=${PROJECT_ID}
    - IMAGE_NAME=${_IMAGE_NAME}:$(cat BUILD_NO)
    - TEMPLATE_LOCATION=${_TEMPLATE_GCS_LOCATION}
    args: ['.deploy/build.sh']

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: build-dataflow-template
    env:
    - JOB_NAME=intro-beam
    - IMAGE_NAME=${_IMAGE_NAME}
    - TEMPLATE_LOCATION=${_TEMPLATE_GCS_LOCATION}
    args: ['.deploy/run.sh']

substitutions:
  _IMAGE_NAME: gcr.io/${PROJECT_ID}/intro_beam
  _TEMPLATE_GCS_LOCATION: gs://dataflow-image-custom/templates/$(cat BUILD_NO).json

options:
  dynamic_substitutions: True

tags: ["my-tag"]

